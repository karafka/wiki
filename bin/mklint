#!/bin/bash

set -e  # Exit on any error

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}üèóÔ∏è  Setting up build directory...${NC}"
rm -rf .lint/
mkdir -p .lint/docs

echo -e "${BLUE}üìÅ Copying docs content to .lint/docs/...${NC}"
rsync -av --exclude='.lint/' --exclude='gh/' --exclude='.git/' --exclude='node_modules' ./ ./.lint/docs/ || {
    echo -e "${RED}‚ùå Failed to copy files${NC}"
    exit 1
}

echo -e "${BLUE}üóëÔ∏è  Additional cleanup (gh/ should already be excluded)...${NC}"
rm -rf ./.lint/docs/gh/

echo -e "${BLUE}üîß Aligning documentation...${NC}"
./bin/align_structure ./.lint/docs/

echo -e "${BLUE}üìù Creating minimal mkdocs config...${NC}"
cat > .lint/mkdocs.yml << 'EOF'
site_name: CI run
edit_uri: ""
docs_dir: 'docs'
site_dir: 'site'
plugins:
  - awesome-pages
EOF

echo -e "${BLUE}üìö Building documentation with strict mode...${NC}"
cd ./.lint

# Auto-generated files should not be linted but since we have references to them instead of
# removing it, we just empty them
echo '' > docs/Librdkafka-Changelog.md
# This is Github repo readme and should not be deployed and checked. Serves as docs repo readme.
rm docs/README.md

# Capture mkdocs output and check for invalid anchor errors
set +e
mkdocs_output=$(mkdocs build --strict 2>&1)
build_exit_code=$?
set -e

# Check for invalid anchor errors specifically
patterns=(
  "does not contain an anchor"
  "contains an unrecognized relative"
  "the target is not found among"
)

# Join array elements with |
IFS='|' pattern="${patterns[*]}"
anchor_errors=$(echo "$mkdocs_output" | grep -E "($pattern)" || true)

echo "$mkdocs_output"

if [ -n "$anchor_errors" ]; then
   echo -e "${RED}‚ùå Found invalid anchor/link errors:${NC}"
   echo "$anchor_errors"
   exit 1
elif [ $build_exit_code -ne 0 ]; then
   echo -e "${YELLOW}‚ö†Ô∏è  MkDocs build had other issues but continuing...${NC}"
   echo "$mkdocs_output"
else
   echo -e "${GREEN}‚úÖ Build completed successfully!${NC}"
   echo -e "${GREEN}üì¶ Output available in: $(pwd)/site/${NC}"
fi
