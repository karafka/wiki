#!/usr/bin/env ruby

# Script that downloads librdkafka statistics documentation

require 'fileutils'
require 'open-uri'

# URL for librdkafka statistics documentation
LIBRDKAFKA_STATS = 'https://raw.githubusercontent.com/confluentinc/librdkafka/master/STATISTICS.md'

# Default output directory - can be overridden via command line
DEFAULT_OUTPUT_DIR = '.'

class LibrdkafkaStatsFetcher
  def initialize(output_dir = DEFAULT_OUTPUT_DIR)
    @output_dir = output_dir
    ensure_output_directory
  end

  def fetch_statistics
    puts "Fetching librdkafka statistics to #{@output_dir}..."

    fetch_statistics_doc

    puts "Done! Fetched librdkafka statistics documentation."
  end

  private

  def ensure_output_directory
    FileUtils.mkdir_p(@output_dir) unless Dir.exist?(@output_dir)
    FileUtils.mkdir_p(File.join(@output_dir, 'Librdkafka')) unless Dir.exist?(File.join(@output_dir, 'Librdkafka'))
  end

  def fetch_statistics_doc
    puts "Fetching librdkafka statistics..."

    begin
      # Fetch content and remove the first line (page title)
      stats_content = URI.open(LIBRDKAFKA_STATS).read.split("\n")[1..].join("\n")

      output_file = File.join(@output_dir, 'Librdkafka', 'Statistics.md')
      write_complete_statistics_file(stats_content, output_file)

      puts "  ✓ Saved to #{output_file}"
    rescue => e
      puts "  ✗ Failed to fetch librdkafka statistics: #{e.message}"
    end
  end

  def write_complete_statistics_file(stats_content, filename)
    File.open(filename, 'w') do |file|
      file.write <<~HEADER
[//]: # (This file is auto-generated by bin/refresh_librdkafka_statistics)
[//]: # (Do not edit manually - changes will be overwritten)

<style>
  .md-grid {
    max-width: 100%;
  }
</style>
# Librdkafka Statistics Metrics Details

!!! note ""
    This page is a copy of the [STATISTICS.md](https://github.com/confluentinc/librdkafka/blob/master/STATISTICS.md) of `librdkafka`.
The statistics presented below are based on the raw metrics from `librdkafka`. However, Karafka and WaterDrop enhance these metrics for a more comprehensive view. By default, both frameworks have the `statistics.interval.ms` set to 5 seconds, meaning statistics are refreshed at this interval. Be mindful of this default setting when analyzing metric data.
***

#{stats_content}
HEADER
    end
  end
end

# Script execution
if __FILE__ == $0
  output_dir = ARGV[0] || DEFAULT_OUTPUT_DIR

  fetcher = LibrdkafkaStatsFetcher.new(output_dir)
  fetcher.fetch_statistics
end
