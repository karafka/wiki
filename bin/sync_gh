#!/usr/bin/env ruby

# Script that makes sure, that the GH wiki header info is present in all the files.
# Builds that and pushes the update to GH.

require 'fileutils'

FailedCommand = Class.new(StandardError)

def system!(cmd)
  system(cmd) || raise(FailedCommand)
end

raise ArgumentError, 'GH wiki version missing' unless File.exist?("#{Dir.pwd}/gh")

Dir["#{Dir.pwd}/**.md"].each do |file|
  basename = File.basename(file)
  target = "#{Dir.pwd}/gh/#{basename}"

  FileUtils.cp(file, target)
end

%w[
  Pro
  Web-UI
  WaterDrop
  Upgrades
].each do |namespace|
  Dir["#{Dir.pwd}/#{namespace}/**.md"].each do |file|
    basename = File.basename(file)
    target = "#{Dir.pwd}/gh/#{namespace}-#{basename}"

    FileUtils.cp(file, target)
  end
end

# Move this to root without a namespace.
# In this case namespace is used only as a organization layer
%w[
  Advanced
].each do |namespace|
  Dir["#{Dir.pwd}/#{namespace}/**.md"].each do |file|
    basename = File.basename(file)
    target = "#{Dir.pwd}/gh/#{basename}"

    FileUtils.cp(file, target)
  end
end

HEADER_TEMPLATE_CONTENT = IO.read("#{Dir.pwd}/gh/_GH_Header.md")

Dir["#{Dir.pwd}/gh/**.md"].each do |file|
  basename = File.basename(file)

  next if basename.start_with?('_')

  rd = IO.read(file)
  IO.write file, HEADER_TEMPLATE_CONTENT + "\n" + rd
end

system!('cd gh/ && git add ./')
system('cd gh/ && git commit -m "docs update"')
system!('cd gh/ && git push origin master')
