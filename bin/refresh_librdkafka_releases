#!/usr/bin/env ruby

# Script that downloads librdkafka releases info and generates changelog

require 'fileutils'
require 'net/http'
require 'json'

# Default output directory - can be overridden via command line
DEFAULT_OUTPUT_DIR = '.'

class LibrdkafkaFetcher
  def initialize(output_dir = DEFAULT_OUTPUT_DIR)
    @output_dir = output_dir
    ensure_output_directory
  end

  def fetch_changelog
    puts "Fetching librdkafka changelog to #{@output_dir}..."

    begin
      url = 'https://api.github.com/repos/confluentinc/librdkafka/releases'
      releases = fetch_releases(url)
      markdown_content = generate_librdkafka_markdown(releases)

      output_file = File.join(@output_dir, 'Librdkafka', 'Changelog.md')
      save_librdkafka_changelog(markdown_content, output_file)

      puts "  ✓ Saved to #{output_file}"
    rescue => e
      puts "  ✗ Failed to fetch librdkafka changelog: #{e.message}"
    end

    puts "Done! Fetched librdkafka changelog."
  end

  private

  def ensure_output_directory
    FileUtils.mkdir_p(@output_dir) unless Dir.exist?(@output_dir)
    FileUtils.mkdir_p(File.join(@output_dir, 'Librdkafka')) unless Dir.exist?(File.join(@output_dir, 'Librdkafka'))
  end

  def fetch_releases(url)
    uri = URI(url)
    response = Net::HTTP.get(uri)
    JSON.parse(response)
  end

  def format_release(release)
    version = release['tag_name'].gsub('v', '')
    published_at = release['published_at'].split('T').first
    body = release['body']

    # Adjust heading levels
    body.gsub!(/^######\s/, '####### ')
    body.gsub!(/^#####\s/, '###### ')
    body.gsub!(/^####\s/, '##### ')
    body.gsub!(/^###\s/, '#### ')
    body.gsub!(/^##\s/, '### ')

    <<~MARKDOWN
## #{version} (#{published_at})

#{body}
    MARKDOWN
  end

  def generate_librdkafka_markdown(releases)
    markdown = ""
    releases.each do |release|
      markdown += format_release(release)
    end
    markdown
  end

  def save_librdkafka_changelog(content, filename)
    File.open(filename, 'w') do |file|
      file.write <<~MSG
[//]: # (This file is auto-generated by bin/refresh_librdkafka)
[//]: # (Do not edit manually - changes will be overwritten)

# Librdkafka Changelog

!!! note ""
    This page is a copy of the [releases](https://github.com/confluentinc/librdkafka/releases) of `librdkafka`.

MSG
      file.write(content)
    end
  end
end

# Script execution
if __FILE__ == $0
  output_dir = ARGV[0] || DEFAULT_OUTPUT_DIR

  fetcher = LibrdkafkaFetcher.new(output_dir)
  fetcher.fetch_changelog
end
